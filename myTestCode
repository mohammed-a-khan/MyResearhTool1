// Check available ODBC drivers on Windows
console.log('=== ODBC Driver Detection ===\n');

const { execSync } = require('child_process');

// Method 1: Check via PowerShell registry
console.log('--- Method 1: Check Registry (PowerShell) ---');
try {
  const output = execSync(
    'powershell -Command "Get-ItemProperty -Path \'HKLM:\\SOFTWARE\\ODBC\\ODBCINST.INI\\ODBC Drivers\' | Select-Object * -ExcludeProperty PS*"',
    { encoding: 'utf8' }
  );
  console.log(output);
} catch (e) {
  console.log('Could not read registry:', e.message);
}

// Method 2: List all installed ODBC drivers
console.log('\n--- Method 2: List All ODBC Drivers (via odbcad32) ---');
try {
  const output = execSync(
    'powershell -Command "Get-OdbcDriver | Where-Object {$_.Name -like \'*SQL Server*\'} | Format-Table Name, Platform, Attribute -AutoSize"',
    { encoding: 'utf8' }
  );
  console.log(output);
} catch (e) {
  console.log('Could not list ODBC drivers:', e.message);
}

// Method 3: Test each driver name with msnodesqlv8
console.log('\n--- Method 3: Test Driver Names with msnodesqlv8 ---');

const driverNames = [
  'ODBC Driver 18 for SQL Server',
  'ODBC Driver 17 for SQL Server',
  'ODBC Driver 13 for SQL Server',
  'ODBC Driver 11 for SQL Server',
  'SQL Server Native Client 11.0',
  'SQL Server Native Client 10.0',
  'SQL Server',
];

async function testDriverName(driverName) {
  try {
    const sql = require('msnodesqlv8');

    // Use a very simple connection string with localhost
    const connString = `Driver={${driverName}};Server=localhost;Timeout=1;`;

    return new Promise((resolve) => {
      // Try to open - we expect timeout, but we're checking if driver is recognized
      const timeout = setTimeout(() => {
        resolve({ driver: driverName, status: 'timeout (driver recognized)' });
      }, 2000);

      sql.open(connString, (err, conn) => {
        clearTimeout(timeout);
        if (err) {
          // Check error message
          if (err.message && err.message.includes('Data source name not found')) {
            resolve({ driver: driverName, status: 'NOT FOUND' });
          } else if (err.message && err.message.includes('Login')) {
            resolve({ driver: driverName, status: 'FOUND (login failed - expected)' });
          } else {
            resolve({ driver: driverName, status: `Error: ${err.message}` });
          }
        } else {
          conn.close(() => {
            resolve({ driver: driverName, status: 'FOUND (connected!)' });
          });
        }
      });
    });
  } catch (e) {
    return { driver: driverName, status: `Exception: ${e.message}` };
  }
}

async function testAllDrivers() {
  console.log('Testing each driver name...\n');

  for (const driverName of driverNames) {
    const result = await testDriverName(driverName);
    const status = result.status.includes('FOUND') ? '✅' :
                   result.status.includes('NOT FOUND') ? '❌' : '⚠️';
    console.log(`${status} ${result.driver}`);
    console.log(`   Status: ${result.status}\n`);
  }

  console.log('\n=== Summary ===');
  console.log('Drivers marked with ✅ are installed and recognized');
  console.log('Drivers marked with ❌ are NOT installed');
  console.log('Use the exact name of a ✅ driver in your connection string');
}

// Run the test
testAllDrivers().catch(err => {
  console.error('Error:', err);
});
