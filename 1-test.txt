export const ELEMENT_TYPE_TO_ROLES: Record<string, string[]> = {
    'button': ['button'],
    'link': ['link'],
    'input': ['textbox', 'searchbox'],
    'textbox': ['textbox'],
    'field': ['textbox', 'searchbox', 'combobox'],
    'text field': ['textbox'],
    'text input': ['textbox'],
    'search': ['searchbox', 'search'],
    'searchbox': ['searchbox'],
    'checkbox': ['checkbox'],
    'radio': ['radio'],
    'radio button': ['radio'],
    'select': ['combobox', 'listbox'],
    'dropdown': ['combobox', 'listbox'],
    'combobox': ['combobox'],
    'listbox': ['listbox'],
    'tab': ['tab'],
    'menu': ['menu'],
    'menu item': ['menuitem'],
    'menuitem': ['menuitem'],
    'heading': ['heading', 'columnheader', 'rowheader', 'banner'],
    'dialog': ['dialog', 'alertdialog'],
    'modal': ['dialog'],
    'switch': ['switch'],
    'slider': ['slider'],
    'progressbar': ['progressbar'],
    'tree': ['tree'],
    'treeitem': ['treeitem'],
    'grid': ['grid'],
    'row': ['row'],
    'cell': ['cell', 'gridcell'],
    'table': ['table'],
    'alert': ['alert'],
    'tooltip': ['tooltip'],
    'img': ['img'],
    'image': ['img'],
    'navigation': ['navigation'],
    'region': ['region'],
    'banner': ['banner'],
    'form': ['form'],
    'option': ['option'],
    'list': ['list'],
    'listitem': ['listitem'],
    'list item': ['listitem'],
    'header': ['heading', 'columnheader', 'rowheader', 'banner'],
    'popup': ['dialog'],
    'toggle button': ['button'],
    'submit': ['button'],
    'submit button': ['button'],
    'section': ['region'],
    'article': ['article'],
    'main': ['main']
};


-------------------------------------------------


// ========================================================================
    // Strategy 3: Text-based Search
    // ========================================================================

    private async matchViaTextSearch(
        page: Page,
        target: ElementTarget
    ): Promise<MatchedElement | null> {
        const searchText = this.buildSearchText(target);
        if (!searchText) return null;

        // Try exact match first — higher confidence, fewer false positives
        // In heavily nested DOMs (legacy apps), inexact search matches ancestor elements too
        try {
            const exactLocator = page.getByText(searchText, { exact: true });
            const exactCount = await exactLocator.count();
            if (exactCount > 0) {
                const baseConfidence = exactCount === 1 ? 0.75 : Math.max(0.5, 0.75 - exactCount * 0.05);
                return {
                    locator: this.selectByOrdinal(exactLocator, exactCount, target.ordinal),
                    broadLocator: exactLocator,
                    confidence: baseConfidence,
                    method: 'text-search',
                    description: `getByText('${searchText}', exact)${exactCount > 1 ? ` (${exactCount} matches)` : ''}`,
                    alternatives: []
                };
            }
        } catch { /* continue */ }

        // Fall back to inexact match
        try {
            const locator = page.getByText(searchText, { exact: false });
            const count = await locator.count();
            if (count > 0) {
                // Reduce confidence when many elements match (broad/generic text)
                // Single match = 0.65, multiple = progressively lower
                const baseConfidence = count === 1 ? 0.65 : Math.max(0.4, 0.65 - count * 0.05);
                return {
                    locator: this.selectByOrdinal(locator, count, target.ordinal),
                    broadLocator: locator,
                    confidence: baseConfidence,
                    method: 'text-search',
                    description: `getByText('${searchText}')${count > 1 ? ` (${count} matches)` : ''}`,
                    alternatives: []
                };
            }
        } catch { /* continue */ }

        // Try with individual descriptor words — lower confidence since these are partial matches
        for (const desc of target.descriptors) {
            if (desc.length < 3) continue;
            try {
                const locator = page.getByText(desc, { exact: false });
                const count = await locator.count();
                if (count > 0 && count <= 10) {
                    // Individual word matches are less reliable
                    const baseConfidence = count === 1 ? 0.45 : Math.max(0.25, 0.45 - count * 0.05);
                    return {
                        locator: this.selectByOrdinal(locator, count, target.ordinal),
                        broadLocator: locator,
                        confidence: baseConfidence,
                        method: 'text-search',
                        description: `getByText('${desc}')${count > 1 ? ` (${count} matches)` : ''}`,
                        alternatives: []
                    };
                }
            } catch { /* continue */ }
        }

        return null;
    }
