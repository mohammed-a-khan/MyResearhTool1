# ==============================================================================
# VDI PERSISTENT CONTEXT — Use signed-in Edge profile (satisfies device compliance)
# Option 1: Auto-detect profile path from current VDI username
# Option 2: Provide explicit path via BROWSER_USER_DATA_DIR
# BROWSER_CLOSE_EXISTING=true closes any running Edge before launching
# ==============================================================================
BROWSER_USE_EXISTING_PROFILE=true
BROWSER_CLOSE_EXISTING=true
# BROWSER_USER_DATA_DIR=C:\Users\YOUR_USERNAME\AppData\Local\Microsoft\Edge\User Data



# ==============================================================================
# MICROSOFT SSO CREDENTIALS
# ==============================================================================
SSO_USERNAME=test1@akhan.net
SSO_PASSWORD=MyPassword1

# Named user aliases (same test ID used for all roles)
SSO_REVIEWER_USERNAME=test1@akhan.net
SSO_REVIEWER_PASSWORD=MyPassword1
SSO_APPROVER_USERNAME=test1@akhan.net
SSO_APPROVER_PASSWORD=MyPassword1


@crm @sso @login-test
Feature: Dynamics 365 CRM - SSO Login Test
    As a test automation engineer
    I want to verify that the Microsoft SSO login works with our framework
    So that we can automate Dynamics 365 CRM tests

    # =========================================================================
    # SCENARIO GROUP 1: Full SSO Login + Session Save
    # =========================================================================

    @smoke
    Scenario: CRM-01 - Login to Dynamics 365 CRM via Microsoft SSO and save session
        # Uses SSO_USERNAME / SSO_PASSWORD from config + saves session for reuse
        Given I login to Microsoft SSO and save session to "auth/crm-session.json"
        Then AI "Verify the page URL contains 'dynamics.com'"
        Then AI "Verify the 'SANDBOX' text should be visible"
        When I click on the Employee tile
        Then I wait for the CRM page to load
        Then I should see the Employee breadcrumb
        Then I should see the Dynamics 365 Overview header

    # =========================================================================
    # SCENARIO GROUP 2: Session Reuse (smart login — skips login if session valid)
    # =========================================================================

    @smoke
    Scenario: CRM-02 - Reuse saved session to skip login
        # ensureLoggedIn() checks session file age, injects cookies, navigates to app
        # Falls back to fresh login if session expired
        Given I ensure SSO login is active
        Then AI "Verify the page URL contains 'dynamics.com'"
        Then AI "Verify the 'SANDBOX' text should be visible"

    # =========================================================================
    # SCENARIO GROUP 3: Session Validation and Management
    # =========================================================================

    @session
    Scenario: CRM-03 - Verify saved session is still valid
        # Checks that the session file exists and is within SSO_SESSION_MAX_AGE_HOURS
        Then the saved SSO session should be valid

    @session
    Scenario: CRM-04 - Clear saved session and perform fresh login
        # Clears the session file, then performs a fresh login
        Given I clear the saved browser session
        Given I login to Microsoft SSO with credentials from config
        Then AI "Verify the page URL contains 'dynamics.com'"
        # Save session again for subsequent scenarios
        Given I save the browser session to "auth/crm-session.json"

    # =========================================================================
    # SCENARIO GROUP 4: Named User Login (reviewer / approver roles)
    # =========================================================================

    @roles
    Scenario: CRM-05 - Login as reviewer using named credentials
        # Looks up SSO_REVIEWER_USERNAME / SSO_REVIEWER_PASSWORD from config
        Given I login to Microsoft SSO as "reviewer"
        Then AI "Verify the page URL contains 'dynamics.com'"
        Then AI "Verify the 'SANDBOX' text should be visible"

    @roles
    Scenario: CRM-06 - Login as approver and save session
        # Looks up SSO_APPROVER_USERNAME / SSO_APPROVER_PASSWORD from config
        # Saves a role-specific session file for approver reuse
        Given I login to Microsoft SSO as "approver" and save session to "auth/crm-approver-session.json"
        Then AI "Verify the page URL contains 'dynamics.com'"
        Then AI "Verify the 'SANDBOX' text should be visible"

    # =========================================================================
    # SCENARIO GROUP 5: Load Session from File
    # =========================================================================

    @session
    Scenario: CRM-07 - Load a previously saved session into browser
        # Injects cookies from saved file into current context (non-destructive)
        Given I load the browser session from "auth/crm-session.json"
        Then AI "Navigate to 'https://myprojectenv.crm.dynamics.com/'"
        Then AI "Verify the page URL contains 'dynamics.com'"

    # =========================================================================
    # SCENARIO GROUP 6: Navigate to URL with SSO Login
    # =========================================================================

    @navigation
    Scenario: CRM-08 - Navigate to a specific CRM URL with SSO login
        # Triggers SSO login using a custom URL instead of SSO_LOGIN_URL config
        Given I navigate to "https://myprojectenv.crm.dynamics.com/" with SSO login
        Then AI "Verify the page URL contains 'dynamics.com'"
        Then AI "Verify the 'SANDBOX' text should be visible"
        # Save session for later scenarios
        Given I save the browser session to "auth/crm-session.json"

    # =========================================================================
    # SCENARIO GROUP 7: Microsoft Login Page Detection
    # =========================================================================

    @detection
    Scenario: CRM-09 - Detect Microsoft login page before authenticating
        # Clear session so we get redirected to the Microsoft login page
        Given I clear the saved browser session
        Then AI "Navigate to 'https://myprojectenv.crm.dynamics.com/'"
        Then I should be on Microsoft login page

    # =========================================================================
    # SCENARIO GROUP 8: Full E2E Flow — Login, Navigate, Verify, Save
    # =========================================================================

    @e2e
    Scenario: CRM-10 - End-to-end CRM login and Employee module navigation
        Given I ensure SSO login is active
        Then AI "Verify the page URL contains 'dynamics.com'"
        Then AI "Verify the 'SANDBOX' text should be visible"
        When I click on the Employee tile
        Then I wait for the CRM page to load
        Then I should see the Employee breadcrumb
        Then I should see the Dynamics 365 Overview header
        # Save session after successful navigation
        Given I save the browser session to "auth/crm-session.json"

    # =========================================================================
    # SCENARIO GROUP 9: Role Switch — Reviewer then Approver in sequence
    # =========================================================================

    @roles @e2e
    Scenario: CRM-11 - Reviewer submits then Approver approves (same test ID)
        # Step 1: Login as reviewer
        Given I login to Microsoft SSO as "reviewer" and save session to "auth/crm-reviewer-session.json"
        Then AI "Verify the page URL contains 'dynamics.com'"
        When I click on the Employee tile
        Then I wait for the CRM page to load
        Then I should see the Employee breadcrumb
        # Reviewer actions would go here (submit a record, etc.)

    @roles @e2e
    Scenario: CRM-12 - Approver continues from reviewer submission
        # Step 2: Login as approver (reuses session if same user, or fresh login)
        Given I login to Microsoft SSO as "approver" and save session to "auth/crm-approver-session.json"
        Then AI "Verify the page URL contains 'dynamics.com'"
        When I click on the Employee tile
        Then I wait for the CRM page to load
        Then I should see the Employee breadcrumb
        # Approver actions would go here (approve the record, etc.)
