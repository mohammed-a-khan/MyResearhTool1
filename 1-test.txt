import { CSBDDStepDef, StepDefinitions } from '@mdakhan.mak/cs-playwright-test-framework/bdd';
import { CSReporter } from '@mdakhan.mak/cs-playwright-test-framework/reporting';
import { CSBrowserManager } from '@mdakhan.mak/cs-playwright-test-framework/browser';
import { createAIStepHandler } from '@mdakhan.mak/cs-playwright-test-framework/ai';

/**
 * AI Step Definitions - Zero-Step Natural Language Test Execution
 *
 * Enables natural language test steps in .feature files using the AI Step Engine.
 * Uses grammar-based NLP parsing + Playwright accessibility tree matching.
 * No external LLM required.
 *
 * Usage in .feature files:
 *   When AI "Click the Login button"
 *   Then AI "Verify the Dashboard heading is displayed"
 *   When AI "Get the text from the heading" and store as "headingText"
 *   When AI "Type in the search field" with value "{scenario:searchTerm}"
 *   When AI "Check the Terms checkbox" if "acceptTerms" is "Yes"
 */
@StepDefinitions
export class AIStepDefinitions {

    private getAIHandler() {
        const browserManager = CSBrowserManager.getInstance();
        const page = browserManager.getPage();
        if (!page) {
            throw new Error('AI Step: No active page. Ensure a browser is launched before using AI steps.');
        }
        return createAIStepHandler(page);
    }

    @CSBDDStepDef('AI {string}')
    async aiStep(instruction: string) {
        CSReporter.info(`AI Step: "${instruction}"`);
        const handler = this.getAIHandler();
        await handler.executeAIStep(instruction);
    }

    @CSBDDStepDef('AI {string} and store as {string}')
    async aiStepAndStore(instruction: string, variableName: string) {
        CSReporter.info(`AI Step (store as "${variableName}"): "${instruction}"`);
        const handler = this.getAIHandler();
        await handler.executeAIStepAndStore(instruction, variableName);
    }

    @CSBDDStepDef('AI {string} with value {string}')
    async aiStepWithValue(instruction: string, value: string) {
        CSReporter.info(`AI Step (with value): "${instruction}" -> "${value}"`);
        const handler = this.getAIHandler();
        await handler.executeAIStepWithValue(instruction, value);
    }

    @CSBDDStepDef('AI {string} if {string} is {string}')
    async aiStepConditional(instruction: string, flagName: string, flagValue: string) {
        CSReporter.info(`AI Step (conditional: ${flagName}=${flagValue}): "${instruction}"`);
        const handler = this.getAIHandler();
        await handler.executeAIStepConditional(instruction, flagName, flagValue);
    }
}

export default AIStepDefinitions;
