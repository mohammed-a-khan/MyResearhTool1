[
  {
    "scenarioId": "EXT12",
    "scenarioName": "Market to CSV and XLSX",
    "userName": "",
    "searchBy": "Rrrrrrrr Date",
    "startDate": "",
    "endDate": "",
    "cumulativeMmteName": "",
    "runFlag": "Yes"
  }
]

----------------------------------------------------------------------------------------------------

// ===================================================================
    // MARKET DATA QUERIES (EXT12)
    // ===================================================================

    /**
     * Get cumulative daily mmtes for market by date range
     * Query: DB_QUERY_GET_FILTERED_FOR_MARKET_BY_DATE
     * Returns: Array of records with columns: RRRRRRRR_DT, MMTE, CUMULATIVE_MMTE_NAME, CUMULATIVE_MMTE_SOURCE_CD
     */
    public static async getCumulativeDailyMmtesForMarketByDateRange(
        startDate: string,
        endDate: string
    ): Promise<any[]> {
        CSReporter.info(`Querying cumulative daily mmtes for market - Date range: ${startDate} to ${endDate}`);

        const result = await CSDBUtils.executeQuery(
            this.DB_ALIAS,
            'GET_FILTERED_FOR_MARKET_BY_DATE',
            [startDate, endDate]
        );

        if (!result.rows || result.rows.length === 0) {
            CSReporter.warn('No cumulative daily mmtes found for the specified date range');
            return [];
        }

        CSReporter.pass(`Found ${result.rows.length} cumulative daily mmte records for market`);
        return result.rows;
    }

    /**
     * Get cumulative daily mmtes for market by name and date range
     * Query: DB_QUERY_GET_FILTERED_FOR_MARKET_BY_NAME_AND_DATE
     * Returns: Array of records with columns: RRRRRRRR_DT, MMTE, CUMULATIVE_MMTE_NAME, CUMULATIVE_MMTE_SOURCE_CD
     */
    public static async getCumulativeDailyMmtesForMarketByNameAndDateRange(
        cumulativeMmteName: string,
        startDate: string,
        endDate: string
    ): Promise<any[]> {
        CSReporter.info(`Querying cumulative daily mmtes for market - Mmte: ${cumulativeMmteName}, Date range: ${startDate} to ${endDate}`);

        const result = await CSDBUtils.executeQuery(
            this.DB_ALIAS,
            'GET_FILTERED_FOR_MARKET_BY_NAME_AND_DATE',
            [cumulativeMmteName, startDate, endDate]
        );

        if (!result.rows || result.rows.length === 0) {
            CSReporter.warn('No cumulative daily mmtes found for the specified criteria');
            return [];
        }

        CSReporter.pass(`Found ${result.rows.length} cumulative daily mmte records for market`);
        return result.rows;
    }


    --------------------------------------------------------------------------------------------------

    tttf-cumulative-mmtes.steps.ts

    // ===================================================================
    // MARKET DATABASE QUERY STEPS (EXT12)
    // ===================================================================

    @CSBDDStepDef('I query cumulative daily mmtes from database for date range')
    async queryCumulativeDailyMmtesForDateRange(): Promise<void> {
        CSReporter.info('Querying cumulative daily mmtes from database for date range');

        const startDate = this.scenarioContext.getVariable<string>('startDate');
        const endDate = this.scenarioContext.getVariable<string>('endDate');

        if (!startDate || !endDate) {
            throw new Error('startDate and endDate must be set in scenario context before querying');
        }

        // Query database for market data
        const dbRecords = await TTTFDatabaseHelper.getCumulativeDailyMmtesForMarketByDateRange(startDate, endDate);

        // Store records and count in scenario context
        this.scenarioContext.setVariable('rsDBCumulativeDailyMmtes', dbRecords);
        this.scenarioContext.setVariable('dbRecordCount', dbRecords.length);

        CSReporter.pass(`Retrieved ${dbRecords.length} records from database for date range ${startDate} to ${endDate}`);
    }

    @CSBDDStepDef('I query cumulative daily mmtes from database for name and date range')
    async queryCumulativeDailyMmtesForNameAndDateRange(): Promise<void> {
        CSReporter.info('Querying cumulative daily mmtes from database for name and date range');

        const cumulativeMmteName = this.scenarioContext.getVariable<string>('cumulativeMmteName');
        const startDate = this.scenarioContext.getVariable<string>('startDate');
        const endDate = this.scenarioContext.getVariable<string>('endDate');

        if (!startDate || !endDate) {
            throw new Error('startDate and endDate must be set in scenario context before querying');
        }

        // Query database for market data
        let dbRecords: any[];
        if (cumulativeMmteName && cumulativeMmteName.trim() !== '') {
            dbRecords = await TTTFDatabaseHelper.getCumulativeDailyMmtesForMarketByNameAndDateRange(
                cumulativeMmteName, startDate, endDate
            );
        } else {
            dbRecords = await TTTFDatabaseHelper.getCumulativeDailyMmtesForMarketByDateRange(startDate, endDate);
        }

        // Store records and count in scenario context
        this.scenarioContext.setVariable('rsDBCumulativeDailyMmtes', dbRecords);
        this.scenarioContext.setVariable('dbRecordCount', dbRecords.length);

        CSReporter.pass(`Retrieved ${dbRecords.length} records from database`);
    }

    @CSBDDStepDef('I wait for market to complete')
    async waitForMarketToComplete(): Promise<void> {
        CSReporter.info('Waiting for market to complete');
        await this.cumulativeMmtesPage.waitForMarketToComplete();
        CSReporter.pass('Market completed');
    }

    @CSBDDStepDef('{string} option should be enabled in Market menu')
    async verifyMarketMenuOptionEnabled(optionName: string): Promise<void> {
        CSReporter.info(`Verifying ${optionName} option is enabled in Market menu`);
        const isEnabled = await this.cumulativeMmtesPage.isMarketMenuOptionEnabled(optionName);
        if (isEnabled) {
            CSReporter.pass(`${optionName} option is enabled in Market menu`);
        } else {
            throw new Error(`${optionName} option is disabled in Market menu`);
        }
    }


    ---------------------------------------------------------------------------------------
    TTTFCumulativeMmtesPage.ts 

    /**
     * Check if market menu option is enabled (aria-disabled='false')
     * Requirement xpath: //span[text()='CSV']/ancestor::li[@aria-disabled='false'][1]
     */
    public async isMarketMenuOptionEnabled(optionName: string): Promise<boolean> {
        const enabledOption = CSElementFactory.createByXPath(
            `//span[@class='sssss-button__label' and text()='Market']/parent::button[@aria-label='Market']/parent::div[1]//div[@class='sssss-balloon__content']//ul[@aria-label='Market']//span[text()='${optionName}']/ancestor::li[@aria-disabled='false'][1]`,
            `Market menu option enabled: ${optionName}`,
            this.page
        );

        try {
            const isVisible = await enabledOption.isVisibleWithTimeout(5000);
            CSReporter.info(`Market option ${optionName} enabled state: ${isVisible}`);
            return isVisible;
        } catch {
            CSReporter.info(`Market option ${optionName} is not enabled`);
            return false;
        }
    }

    /**
     * Wait for market to complete (wait for "Marketing" spinner to disappear)
     * Requirement: Wait for element //span[contains(text(), 'Marketing')] to not exist
     */
    public async waitForMarketToComplete(): Promise<void> {
        const marketingSpinner = CSElementFactory.createByXPath(
            `//span[@class='sssss-button__label' and contains(text(), 'Marketing')]`,
            'Marketing spinner',
            this.page
        );

        // First wait 5 seconds
        CSReporter.info('Waiting 5 seconds for market to start...');
        await this.page.waitForTimeout(5000);

        // Check if marketing is still happening
        let isMarketing = await marketingSpinner.isVisibleWithTimeout(1000).catch(() => false);

        if (isMarketing) {
            CSReporter.info('Market still in progress, waiting additional 8 seconds...');
            await this.page.waitForTimeout(8000);
        }

        // Final check - marketing should be complete
        isMarketing = await marketingSpinner.isVisibleWithTimeout(1000).catch(() => false);
        if (isMarketing) {
            CSReporter.warn('Market still showing after 13 seconds wait');
        } else {
            CSReporter.pass('Market completed');
        }
    }


    ---------------------------------------------------------------------------------------------------

    @regression @cumulativeMmtes @market @EXT12
Feature: Cumulative Mmtes - Market Results to CSV and XLSX
  As a TTTF user
  I want to market search results to CSV and XLSX formats
  So that I can analyze cumulative mmtes data offline

  @market @csv @xlsx @dataValidation
  Scenario Outline: Verify Market functionality of Results grid data
    # ============================================================
    # TEST DATA SETUP
    # StartDate = current date - 5 business days
    # EndDate = current date - 1 business day
    # ============================================================
    Given I resolve start date as 5 business days ago if not provided "<startDate>"
    And I resolve end date as 1 business day ago if not provided "<endDate>"

    # ============================================================
    # LOGIN AND NAVIGATION
    # ============================================================
    Given I login to TTTF as "<userName>"
    And I should see the Home page
    And I should see welcome message with username "<userName>"
    And I should see menu item "Cumulative Mmtes"
    When I click on menu item "Cumulative Mmtes"
    Then I should see Cumulative Mmtes page header

    # ============================================================
    # SEARCH BY RRRRRRRR DATE
    # ============================================================
    When I select "Rrrrrrrr Date" from Type dropdown
    Then From date input should be visible
    And To date input should be visible
    When I enter From date "{scenario:startDate}"
    And I enter To date "{scenario:endDate}"
    Then Search button should be enabled
    When I click Search button
    Then I should see Displaying header

    # ============================================================
    # VERIFY SEARCH RESULTS AND FILTERS
    # ============================================================
    Then I should see filter "Rrrrrrrr Date From" with value "{scenario:startDate}"
    And I should see filter "Rrrrrrrr Date To" with value "{scenario:endDate}"
    And results table should have data

    # ============================================================
    # QUERY DATABASE AND VERIFY RESULTS COUNT
    # ============================================================
    When I query cumulative daily mmtes from database for date range
    Then the total results count should match database

    # ============================================================
    # VERIFY MARKET BUTTON
    # ============================================================
    Then Market button should be visible and enabled

    # ============================================================
    # VERIFY MARKET MENU OPTIONS
    # ============================================================
    When I click Market button
    Then Market menu should be displayed
    And CSV option should be visible and enabled
    And "CSV" option should be enabled in Market menu
    And XLSX option should be visible and enabled
    And "XLSX" option should be enabled in Market menu

    # ============================================================
    # MARKET TO CSV - CAPTURE, DOWNLOAD, VERIFY
    # ============================================================
    When I capture the latest CSV file before market
    And I click CSV option in Market menu
    And I wait for market to complete
    Then CSV file should be downloaded
    And CSV filename should match pattern "CumulativeMmtesMarket_MMDDYYYY.csv"
    And CSV data should match database records

    # ============================================================
    # MARKET TO XLSX - CAPTURE, DOWNLOAD, VERIFY
    # ============================================================
    When I capture the latest XLSX file before market
    And I click Market button
    Then Market menu should be displayed
    When I click XLSX option in Market menu
    And I wait for market to complete
    Then XLSX file should be downloaded
    And XLSX filename should match pattern "CumulativeMmtesMarket_MMDDYYYY.xlsx"
    And XLSX data should match database records

    Examples: {"type": "json", "source": "test/tttf/data/cumulative_mmte_market_ext12_scenarios.json", "path": "$", "filter": "scenarioId=EXT12 AND runFlag=Yes"}
