@regression @cumulativeMmtes @edit @crud @EXT07
Feature: Cumulative Mmtes - Edit Daily Mmte Record's Cumulative Reference Name
  As a TTTF user
  I want to edit the Cumulative Reference Name of a daily mmte record
  So that I can correct or update the mmte assignment

  @edit @duplicateValidation @errorHandling
  Scenario Outline: Edit Cumulative Reference Name with cancel, duplicate validation, and successful update
    # ============================================================
    # TEST DATA SETUP
    # ============================================================
    Given I resolve cumulative mmte name from database if not provided "<cumulativeMmteName>"
    And I resolve rrrrrrrr date for MANUAL source records at least 5 months old if not provided "<startDate>"
    And I set end date same as start date

    # ============================================================
    # LOGIN AND NAVIGATION
    # ============================================================
    Given I login to TTTF as "<userName>"
    And I navigate to "Cumulative Mmtes" page

    # ============================================================
    # SEARCH BY CUMULATIVE MMTE AND RRRRRRRR DATE
    # ============================================================
    When I select "Cumulative Mmte" from Type dropdown
    And I select "{scenario:cumulativeMmteName}" from Name dropdown
    And I click Add Condition button
    And I select "Rrrrrrrr Date" from And condition Type dropdown
    Then From date input field should be present
    And To date input field should be present
    When I enter From date "{scenario:startDate}"
    And I enter To date "{scenario:endDate}"
    And I click Search button
    Then I should see Displaying section with results
    And I should see filter "Cumulative Mmte" with value "{scenario:cumulativeMmteName}"
    And I should see filter "Rrrrrrrr Date From" with value "{scenario:startDate}"
    And I should see filter "Rrrrrrrr Date To" with value "{scenario:endDate}"
    And results table should have data

    # ============================================================
    # CAPTURE INITIAL VALUES FROM RESULTS GRID
    # ============================================================
    And I capture row 1 cell values for comparison

    # ============================================================
    # OPEN EDIT MODAL AND VERIFY ELEMENTS
    # ============================================================
    When I click Edit button for row 1
    Then Edit Instance modal should be displayed
    And Edit Instance header should be visible
    And X Close button should be visible in modal header
    And Cumulative Reference dropdown should be visible
    And Cumulative Reference dropdown should show "{scenario:initialCumulativeMmteName}" selected
    When I click Cumulative Reference dropdown in modal
    Then Cumulative Reference dropdown options list should be visible
    And I verify all cumulative mmte options from database are present
    When I close dropdown by clicking outside
    And Rrrrrrrr Date input should be visible in modal
    And Rrrrrrrr Date input should show "{scenario:initialRrrrrrrrDate}"
    And Mmte input should be visible in modal
    And Mmte input should show "{scenario:initialMmtePercentage}"
    And Save button should be visible and enabled
    And Cancel button should be visible and enabled

    # ============================================================
    # TEST CANCEL OPERATION - NO CHANGES SAVED
    # ============================================================
    When I click Cancel button in modal
    Then Edit Instance modal should be closed
    And row 1 "Rrrrrrrr Date" should equal "{scenario:initialRrrrrrrrDate}"
    And row 1 "Mmte (%)" should equal "{scenario:initialMmtePercentage}"
    And row 1 "Cumulative Mmte Name" should equal "{scenario:initialCumulativeMmteName}"
    And row 1 "Source" should equal "{scenario:initialSource}"
    And row 1 "Supplication Date" should equal "{scenario:initialSupplicationDate}"
    Then database record should be unchanged for original cumulative mmte

    # ============================================================
    # TEST EDIT WITH DUPLICATE CUMULATIVE MMTE - ERROR VALIDATION
    # ============================================================
    When I click Edit button for row 1
    Then Edit Instance modal should be displayed
    When I get existing cumulative mmte with daily mmte for same rrrrrrrr date from database
    And I click Cumulative Reference dropdown in modal
    Then Cumulative Reference dropdown options list should be visible
    And option "{scenario:existingDailyMmteName}" should be visible in dropdown
    When I select "{scenario:existingDailyMmteName}" option from Cumulative Reference dropdown
    Then Cumulative Reference dropdown should show "{scenario:existingDailyMmteName}" selected
    When I click Save button in modal
    Then error message should be displayed in modal
    And error message should be "A {scenario:existingDailyMmteName} mmte instance already exists on {scenario:initialRrrrrrrrDate}."
    Then database record should be unchanged for original cumulative mmte
    When I click Cancel button in modal
    Then Edit Instance modal should be closed

    # ============================================================
    # TEST EDIT WITH VALID CUMULATIVE MMTE - SUCCESSFUL UPDATE
    # ============================================================
    When I click Edit button for row 1
    Then Edit Instance modal should be displayed
    When I get cumulative mmte without daily mmte for same rrrrrrrr date from database
    And I click Cumulative Reference dropdown in modal
    Then Cumulative Reference dropdown options list should be visible
    And option "{scenario:nonExistingDailyMmteName}" should be visible in dropdown
    When I select "{scenario:nonExistingDailyMmteName}" option from Cumulative Reference dropdown
    Then Cumulative Reference dropdown should show "{scenario:nonExistingDailyMmteName}" selected
    When I click Save button in modal
    Then Edit Instance modal should be closed
    And results table should show "No data available."

    # ============================================================
    # DATABASE VERIFICATION AFTER SUCCESSFUL UPDATE
    # ============================================================
    Then database should not have record for "{scenario:initialCumulativeMmteName}" on "{scenario:initialRrrrrrrrDate}"
    And database should have record for "{scenario:nonExistingDailyMmteName}" on "{scenario:initialRrrrrrrrDate}"
    And database record rrrrrrrr date should be "{scenario:initialRrrrrrrrDate}"
    And database record mmte should be "{scenario:initialMmtePercentage}"
    And database record cumulative mmte name should be "{scenario:nonExistingDailyMmteName}"
    And database record source should be "MANUAL"
    And database record supplication date should be "{scenario:initialSupplicationDate}"

    Examples: {"type": "json", "source": "test/tttf/data/cumulative_mmte_edit_ext07_scenarios.json", "path": "$", "filter": "scenarioId=EXT07 AND runFlag=Yes"}
